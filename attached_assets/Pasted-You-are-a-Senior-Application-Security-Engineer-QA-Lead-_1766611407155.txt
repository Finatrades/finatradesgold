You are a Senior Application Security Engineer + QA Lead. 
Your job is to perform an END-TO-END security test of this entire web platform inside this Replit codebase and deliver a clear, actionable report + fixes.

========================
0) RULES (MUST FOLLOW)
========================
- Work ONLY inside this repository. Do not assume external systems unless configured here.
- Do NOT break production; run tests on local/staging configs only.
- Do NOT delete data. Use mock/demo accounts and seed data.
- Every finding must include: (a) risk level, (b) how to reproduce, (c) impacted file(s), (d) exact fix (code), (e) verification steps.
- Prioritize OWASP Top 10 + OWASP API Top 10 + fintech wallet/vault logic risks (double spend, IDOR, privilege escalation).
- If you find secrets/keys, immediately: rotate recommendation + remove from code + add to env/secrets manager + add gitignore.
- Create a folder: /security_audit/ and store all outputs there.

========================
1) DISCOVER & MAP THE APP
========================
1.1 Identify:
- Tech stack (frontend, backend, DB, auth)
- Entry points (web routes, API routes)
- Role model (user/admin/ops)
- All environment variables and config loaders
Output:
- /security_audit/01-architecture-map.md
- /security_audit/01-routes-endpoints-inventory.md (table of endpoints, auth required, roles)

Commands:
- List directory structure
- Search for routes/controllers/api handlers
- Search for auth middleware and RBAC checks

========================
2) SECRETS & CONFIG LEAKAGE SCAN (CRITICAL)
========================
2.1 Scan the repo for secrets:
- API keys, tokens, private keys, seed phrases
- hardcoded passwords
- .env committed
- database connection strings
2.2 If found:
- remove from code
- move to Replit Secrets / env vars
- add .env to .gitignore
Outputs:
- /security_audit/02-secrets-report.md
- PR-style patch with fixes

Search patterns:
"API_KEY" "SECRET" "PRIVATE_KEY" "BEGIN RSA" "mnemonic" "password=" "token=" "aws_access_key" "firebase" "supabase" "jwt"

========================
3) DEPENDENCY / SUPPLY CHAIN SECURITY
========================
3.1 Run dependency audit:
- npm/yarn/pnpm audit OR pip safety OR composer audit (based on stack)
3.2 Upgrade and patch where safe
Outputs:
- /security_audit/03-dependency-audit.md
- lockfile + package updates

========================
4) AUTHENTICATION SECURITY TESTS
========================
4.1 Validate:
- password policy, hashing (bcrypt/argon2), login throttling
- session/jwt expiry, refresh token rotation, logout invalidation
- MFA support (if exists)
4.2 Attempt attacks:
- brute force (should rate limit / lockout)
- session fixation
- JWT tampering (alg=none, kid injection, expired tokens)
Outputs:
- /security_audit/04-auth-tests.md
- code fixes in auth middleware/services

========================
5) AUTHORIZATION & RBAC (IDOR / PRIV ESCALATION)
========================
5.1 For every API endpoint:
- confirm authorization checks exist
- ensure object-level authorization (ownership) is enforced
5.2 Run tests:
- user tries admin endpoints
- user tries other user’s wallet/transactions by changing IDs
- modify role/accountType in payload (mass assignment)
Outputs:
- /security_audit/05-rbac-idor-report.md
- patched middleware + endpoint guards + model validation

========================
6) INPUT VALIDATION & INJECTION TESTS (OWASP)
========================
6.1 Server-side validation:
- SQLi, NoSQLi, command injection, path traversal
6.2 Client-side:
- XSS, DOM injection
6.3 Ensure safe:
- parameterized queries / ORM safe usage
- sanitization and output encoding
Outputs:
- /security_audit/06-injection-xss-report.md
- fixes in validators, query builders, templates

========================
7) CSRF / CORS / SECURITY HEADERS
========================
7.1 Check:
- CSRF protection (if cookie auth)
- CORS policy (no wildcard with credentials)
- Headers: CSP, HSTS, X-Frame-Options, X-Content-Type-Options, Referrer-Policy
Outputs:
- /security_audit/07-headers-cors-csrf.md
- middleware updates (helmet or equivalent)

========================
8) FILE UPLOAD SECURITY (IF ANY)
========================
8.1 Verify:
- allowed file types & size limits
- virus/malware scanning suggestion
- storage path safety (no traversal)
- no public bucket exposure
Outputs:
- /security_audit/08-file-upload-report.md
- fixes in upload handlers

========================
9) FINTECH BUSINESS LOGIC TESTS (MOST IMPORTANT FOR WALLET/Vault)
========================
You MUST search for: wallet balance updates, ledger entries, vault ownership, bnsl locks, trade locks, withdrawals.
Test for:
- Double spend (repeat same request, retry, concurrent requests)
- Race conditions on transfer/withdraw
- Missing ledger entry when balance changes
- Negative balances / rounding abuse
- Price manipulation: fallback price, client-provided price, stale price acceptance
- Replay attacks on webhooks/callbacks (if payment gateways)
- Admin override endpoints abuse
Outputs:
- /security_audit/09-business-logic-report.md
- code fixes: DB transactions, row locks, idempotency keys, request dedupe, server-side price source validation

Implementation requirements:
- Use DB transactions for any balance change
- Use idempotency keys for payments/transfers
- Use atomic updates and unique constraints
- Ensure ledger is append-only, balances derived or reconciled

========================
10) DATA PROTECTION & PRIVACY
========================
10.1 Verify:
- encryption at rest/transport (TLS)
- PII masking in logs
- no sensitive data in frontend/localStorage
- proper access to KYC docs
Outputs:
- /security_audit/10-data-protection.md
- fixes in logging + storage patterns

========================
11) AUTOMATED SECURITY TEST SUITE (ADD TO REPO)
========================
Add:
- unit tests for RBAC + IDOR
- integration tests for critical endpoints
- security regression tests (basic)
Outputs:
- /security_audit/11-security-tests.md
- /tests/security/* (or project’s test folder)

========================
12) FINAL REPORT + FIX VERIFICATION
========================
Create:
- /security_audit/FINAL-SECURITY-REPORT.md with:
  1) Executive summary
  2) Risk rating (Critical/High/Medium/Low)
  3) Findings table
  4) Repro steps
  5) Patched files list
  6) How to verify each fix
  7) Remaining recommendations (infra, WAF, monitoring)

Also output:
- /security_audit/patch-summary.md (bullet list of code changes)

========================
NOW START
========================
Step A: Print the app architecture map + endpoints inventory first.
Step B: Run secrets scan next.
Step C: Then proceed in the order above and implement fixes as you go.
